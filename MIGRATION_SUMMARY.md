# SIA é¡¹ç›®é‡æ„å®Œæˆæ€»ç»“

## ğŸ‰ é‡æ„æˆåŠŸï¼

æ‚¨çš„é¡¹ç›®å·²æˆåŠŸä»ç®€å•çš„å‘½ä»¤è¡Œå·¥å…·é‡æ„ä¸º**æ ‡å‡†ä¼ä¸šçº§gRPCæœåŠ¡**ï¼Œç°åœ¨å¯ä»¥æä¾›ç»™å¤–éƒ¨æ¥å£è°ƒç”¨ã€‚

## ğŸ“‹ é‡æ„å‰åå¯¹æ¯”

### é‡æ„å‰ï¼ˆæ—§æ¶æ„ï¼‰
```
sia/
â”œâ”€â”€ image_agent.go    # å•ä¸€æ–‡ä»¶åŒ…å«æ‰€æœ‰é€»è¾‘
â”œâ”€â”€ image_client.go   # å›¾ç‰‡ç”Ÿæˆå®¢æˆ·ç«¯
â”œâ”€â”€ image_types.go    # ç±»å‹å®šä¹‰
â”œâ”€â”€ main.go          # ç®€å•çš„å‘½ä»¤è¡Œå…¥å£
â””â”€â”€ go.mod
```

### é‡æ„åï¼ˆä¼ä¸šçº§æ¶æ„ï¼‰
```
sia/
â”œâ”€â”€ api/image/v1/           # gRPC APIå®šä¹‰
â”œâ”€â”€ cmd/server/             # æœåŠ¡å™¨å…¥å£
â”œâ”€â”€ internal/               # å†…éƒ¨ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ config/            # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ domain/            # ä¸šåŠ¡é¢†åŸŸ
â”‚   â”œâ”€â”€ server/            # æœåŠ¡å™¨å®ç°
â”‚   â””â”€â”€ service/           # ä¸šåŠ¡æœåŠ¡
â”œâ”€â”€ pkg/logger/            # å…¬å…±æ—¥å¿—åŒ…
â”œâ”€â”€ proto/                 # protobufå®šä¹‰
â”œâ”€â”€ examples/client/       # å®¢æˆ·ç«¯ç¤ºä¾‹
â”œâ”€â”€ scripts/               # è¿ç»´è„šæœ¬
â”œâ”€â”€ bin/                   # ç¼–è¯‘è¾“å‡º
â”œâ”€â”€ Dockerfile             # å®¹å™¨åŒ–
â”œâ”€â”€ docker-compose.yml     # ç¼–æ’é…ç½®
â””â”€â”€ å®Œæ•´çš„æ–‡æ¡£å’Œé…ç½®æ–‡ä»¶
```

## âœ… æ–°å¢çš„ä¼ä¸šçº§åŠŸèƒ½

### 1. gRPCæœåŠ¡æ¥å£
- **GenerateImage**: åŒæ­¥ç”Ÿæˆå›¾ç‰‡
- **GenerateImageAsync**: å¼‚æ­¥ç”Ÿæˆå›¾ç‰‡  
- **GetImageTask**: æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
- **GenerateSequentialImages**: åºåˆ—å›¾ç‰‡ç”Ÿæˆ
- **HealthCheck**: å¥åº·æ£€æŸ¥

### 2. ä¼ä¸šçº§åŸºç¡€è®¾æ–½
- âœ… **é…ç½®ç®¡ç†**: ç¯å¢ƒå˜é‡ + .envæ–‡ä»¶
- âœ… **ç»“æ„åŒ–æ—¥å¿—**: JSONæ ¼å¼ï¼Œä¾¿äºæ—¥å¿—åˆ†æ
- âœ… **å¥åº·æ£€æŸ¥**: HTTP `/health` å’Œ gRPC åŒé‡æ£€æŸ¥
- âœ… **ä¼˜é›…å…³é—­**: ä¿¡å·å¤„ç†å’Œèµ„æºæ¸…ç†
- âœ… **é”™è¯¯å¤„ç†**: ç»Ÿä¸€çš„gRPCçŠ¶æ€ç 
- âœ… **ä»»åŠ¡ç®¡ç†**: å¼‚æ­¥ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª

### 3. è¿ç»´æ”¯æŒ
- âœ… **å®¹å™¨åŒ–**: Docker + Docker Compose
- âœ… **è‡ªåŠ¨åŒ–æ„å»º**: Makefile
- âœ… **æµ‹è¯•è„šæœ¬**: å®Œæ•´çš„æµ‹è¯•æµç¨‹
- âœ… **å®¢æˆ·ç«¯ç¤ºä¾‹**: Go gRPCå®¢æˆ·ç«¯
- âœ… **å®Œæ•´æ–‡æ¡£**: é¡¹ç›®ç»“æ„å’Œä½¿ç”¨è¯´æ˜

## ğŸš€ å¦‚ä½•ä½¿ç”¨æ–°çš„gRPCæœåŠ¡

### å¯åŠ¨æœåŠ¡å™¨
```bash
# æ–¹å¼1: ä½¿ç”¨ç¼–è¯‘å¥½çš„å¯æ‰§è¡Œæ–‡ä»¶
./bin/sia-server

# æ–¹å¼2: ç›´æ¥è¿è¡Œ
go run cmd/server/main.go

# æ–¹å¼3: ä½¿ç”¨Docker
docker-compose up -d
```

### å¤–éƒ¨è°ƒç”¨ç¤ºä¾‹

#### Goå®¢æˆ·ç«¯
```go
conn, _ := grpc.Dial("localhost:8080", grpc.WithTransportCredentials(insecure.NewCredentials()))
client := imagev1.NewImageServiceClient(conn)

// ç”Ÿæˆå›¾ç‰‡
resp, err := client.GenerateImage(context.Background(), &imagev1.GenerateImageRequest{
    Prompt: "ä¸€åªå¯çˆ±çš„å°çŒ«åœ¨èŠ±å›­é‡Œç©è€",
    Size: "2K",
    Watermark: true,
})
```

#### å…¶ä»–è¯­è¨€å®¢æˆ·ç«¯
ä½¿ç”¨ `proto/image_service.proto` æ–‡ä»¶å¯ä»¥ç”Ÿæˆä»»ä½•è¯­è¨€çš„å®¢æˆ·ç«¯ï¼š
- Python: `python -m grpc_tools.protoc`
- Java: `protoc --java_out=`
- JavaScript: `protoc --js_out=`
- C#: `protoc --csharp_out=`

### HTTPå¥åº·æ£€æŸ¥
```bash
curl http://localhost:9090/health
curl http://localhost:9090/ready
```

## ğŸ”§ é…ç½®è¯´æ˜

### å¿…éœ€é…ç½®
```bash
# å›¾ç‰‡ç”ŸæˆAPIå¯†é’¥ï¼ˆå¿…éœ€ï¼‰
IMAGE_API_KEY=your_api_key_here

# å¯é€‰é…ç½®
GRPC_PORT=8080          # gRPCæœåŠ¡ç«¯å£
HTTP_PORT=9090          # HTTPæœåŠ¡ç«¯å£
LOG_LEVEL=info          # æ—¥å¿—çº§åˆ«
APP_ENVIRONMENT=production  # è¿è¡Œç¯å¢ƒ
```

## ğŸ“Š æœåŠ¡ç›‘æ§

### æœåŠ¡ç«¯ç‚¹
- **gRPCæœåŠ¡**: `localhost:8080`
- **å¥åº·æ£€æŸ¥**: `http://localhost:9090/health`
- **å°±ç»ªæ£€æŸ¥**: `http://localhost:9090/ready`

### æ—¥å¿—æ ¼å¼
```json
{
  "time": "2025-09-14T15:15:36.902499+08:00",
  "level": "INFO",
  "msg": "Starting SIA Image Service",
  "version": "1.0.0",
  "environment": "development",
  "grpc_port": 8080,
  "http_port": 9090
}
```

## ğŸ—‘ï¸ å·²æ¸…ç†çš„æ–‡ä»¶

ä»¥ä¸‹æ—§æ–‡ä»¶å·²è¢«åˆ é™¤ï¼ŒåŠŸèƒ½å·²æ•´åˆåˆ°æ–°æ¶æ„ä¸­ï¼š
- ~~`image_agent.go`~~ â†’ `internal/service/image_service.go`
- ~~`image_client.go`~~ â†’ `internal/domain/image_client.go`  
- ~~`image_types.go`~~ â†’ `internal/domain/types.go`
- ~~`main.go`~~ â†’ `cmd/server/main.go`
- ~~`sia`~~ â†’ `bin/sia-server`

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### ç”Ÿäº§éƒ¨ç½²
1. **é…ç½®TLS**: ä¸ºgRPCæœåŠ¡å¯ç”¨TLSåŠ å¯†
2. **è´Ÿè½½å‡è¡¡**: ä½¿ç”¨nginxæˆ–äº‘è´Ÿè½½å‡è¡¡å™¨
3. **ç›‘æ§å‘Šè­¦**: é›†æˆPrometheus + Grafana
4. **æ—¥å¿—æ”¶é›†**: ä½¿ç”¨ELKæˆ–äº‘æ—¥å¿—æœåŠ¡
5. **CI/CD**: è®¾ç½®è‡ªåŠ¨åŒ–éƒ¨ç½²æµç¨‹

### åŠŸèƒ½æ‰©å±•
1. **è®¤è¯æˆæƒ**: æ·»åŠ JWTæˆ–API Keyè®¤è¯
2. **é™æµæ§åˆ¶**: å®ç°è¯·æ±‚é™æµå’Œç†”æ–­
3. **ç¼“å­˜æœºåˆ¶**: æ·»åŠ Redisç¼“å­˜
4. **æ•°æ®åº“**: é›†æˆæ•°æ®åº“å­˜å‚¨ä»»åŠ¡ä¿¡æ¯
5. **æ¶ˆæ¯é˜Ÿåˆ—**: ä½¿ç”¨RabbitMQæˆ–Kafkaå¤„ç†å¼‚æ­¥ä»»åŠ¡

## âœ¨ æ€»ç»“

æ‚¨çš„é¡¹ç›®ç°åœ¨å·²ç»æ˜¯ä¸€ä¸ª**å®Œæ•´çš„ä¼ä¸šçº§å¾®æœåŠ¡**ï¼Œå…·å¤‡ï¼š

- ğŸ”Œ **æ ‡å‡†gRPCæ¥å£** - æ”¯æŒå¤šè¯­è¨€å®¢æˆ·ç«¯è°ƒç”¨
- ğŸ—ï¸ **ä¼ä¸šçº§æ¶æ„** - åˆ†å±‚æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤
- ğŸ“¦ **å®¹å™¨åŒ–éƒ¨ç½²** - æ”¯æŒDockerå’ŒKubernetes
- ğŸ“Š **å®Œæ•´ç›‘æ§** - å¥åº·æ£€æŸ¥ã€æ—¥å¿—ã€æŒ‡æ ‡
- ğŸ›¡ï¸ **ç”Ÿäº§å°±ç»ª** - ä¼˜é›…å…³é—­ã€é”™è¯¯å¤„ç†ã€é…ç½®ç®¡ç†

ç°åœ¨æ‚¨å¯ä»¥å°†æ­¤æœåŠ¡éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Œä¸ºå‰ç«¯åº”ç”¨æˆ–å…¶ä»–å¾®æœåŠ¡æä¾›ç¨³å®šçš„å›¾ç‰‡ç”ŸæˆAPIæœåŠ¡ï¼